/*
 *  The main JavaScript file for Theme Miracles
 *
 *  @Author:  Eltrac
 *  @License: MIT
 */
 
/**
 *  Use cookies
 */
//add cookie
function addCookie(name,value,expireHours){ 
    var cookieString=name+"="+escape(value);
    if(expireHours>0){ 
      var date=new Date(); 
	  date.setTime(date.getTime+expireHours*3600*1000); 
	  cookieString=cookieString+"; expire="+date.toGMTString(); 
    } 
    document.cookie=cookieString; 
}
//Delete cookie
function deleteCookie(name){ 
    var date=new Date(); 
    date.setTime(date.getTime()-10000); 
    document.cookie=name+"=v; expire="+date.toGMTString(); 
} 
//Get cookie
function getCookie(cname){ 
    var name = cname + "=";
    var decodedCookie = decodeURIComponent(document.cookie);
    var ca = decodedCookie.split(';');
    for(var i = 0; i <ca.length; i++) {
        var c = ca[i];
        while (c.charAt(0) == ' ') {
            c = c.substring(1);
         }
         if (c.indexOf(name) == 0) {
            return c.substring(name.length, c.length);
         }
     }
    return "";
}

/**
 *  Dark theme
 */
//toggleDark
function Dark() {
	//Add classs to use dark theme
	$("body").toggleClass("body-dark");
	//Add cookie to record
	if($("body").hasClass("body-dark")) {
	    addCookie("darkTheme","on",9);
	}else{
		addCookie("darkTheme","off",9);
	}
}

/**
 *  Use filters
 */
//toggleGray
function Gray() {
	$("html").toggleClass("html-filter-gray");
	$("html").removeClass("html-filter-sepia");
    //add cookie to record
	if($("html").hasClass("html-filter-gray")) {
	    addCookie("grayFilter","on",0);
	}else{
		addCookie("grayFilter","off",0);
	}
}
//toggleSepia
function Sepia() {
	$("html").toggleClass("html-filter-sepia");
	$("html").removeClass("html-filter-gray");
	//add cookie to record
	if($("html").hasClass("html-filter-sepia")) {
	    addCookie("sepiaFilter","on",0);
	}else{
		addCookie("sepiaFilter","off",0);
	}
}

/**
 *  Explore and load themes/filter
 */
//explore and load dark theme
var whetherDark = getCookie("darkTheme");
var whetherGray = getCookie("grayFilter");
var whetherSepia = getCookie("sepiaFilter");
if(whetherDark == "on") {
	$("body").addClass("body-dark");
}
else if(whetherGray == "on") {
	$("html").addClass("html-filter-gray");
}
else if(whetherSepia == "on") {
	$("html").addClass("html-filter-sepia");
}

/**
 *  GoTop
 */
function GoTop() {
	$('body,html').animate({scrollTop:0},500);
	document.body.scrollTop = 0;
    document.documentElement.scrollTop = 0;
}

/**
 *  Js Loader
 */
//LazyLoad
function LazyLoad() {
	jQuery(function() {
		jQuery("img").lazyload(
		  {threshold: 200,effect: "fadeIn"}
		);
	});
}
//highlight
function highlight() {
   $(document).ready(function () {
       $('pre code').each(function (i, block) {
           hljs.highlightBlock(block);
		   hljs.initLineNumbersOnLoad();
       })
   });
}
//owo
function owoLoad() {
	var OwO_demo = new OwO({
		logo: 'OωO表情',
		container: document.getElementsByClassName('OwO')[0],
		target: document.getElementsByClassName('OwO-textarea')[0],
		api: owoJson,
		position: 'down',
		width: '300px',
		maxHeight: '250px'
	});
}
//Pangu.js
function panguLoad() {
	document.addEventListener('DOMContentLoaded', () => {
        pangu.autoSpacingPage();
    });
}

/**
 *  Prevent Scroll
 */
function bodyScroll(event){  
    event.preventDefault();  
} 
function banScroll() {
    $('html').css({'overflow':'hidden','padding-right':'9px'});
}
function allowScroll() {
	$('html').css({'overflow':'auto','padding-right':'0'});
}

/**
 *  Front Options Pannel
 */
  //FontFamily
  function ChangeToSerif() {
	  $('body').addClass('body-serif');
	  $('.options-serif-button').addClass('options-button-active');
	  $('.options-sans-button').removeClass('options-button-active');
  }
  function ChangeToSansSerif() {
	  $('body').removeClass('body-serif');
	  $('.options-serif-button').removeClass('options-button-active');
	  $('.options-sans-button').addClass('options-button-active');
  }
  //SizeContent
  function SizeSmall() {
	  //add class for body
	  $('body').addClass('body-contentsize-small');
	  $('body').removeClass('body-contentsize-normal');
	  $('body').removeClass('body-contentsize-big');
	  $('body').removeClass('body-contentsize-large');
	  //active button
	  $('.options-sizesmall').addClass('options-button-active');
	  $('.options-sizenormal').removeClass('options-button-active');
	  $('.options-sizebig').removeClass('options-button-active');
	  $('.options-sizelarge').removeClass('options-button-active');
  }
  function SizeNormal() {
	  $('body').removeClass('body-contentsize-small');
	  $('body').addClass('body-contentsize-normal');
	  $('body').removeClass('body-contentsize-big');
	  $('body').removeClass('body-contentsize-large');
	  //active button
	  $('.options-sizesmall').removeClass('options-button-active');
	  $('.options-sizenormal').addClass('options-button-active');
	  $('.options-sizebig').removeClass('options-button-active');
	  $('.options-sizelarge').removeClass('options-button-active');
  }
  function SizeBig() {
	  $('body').removeClass('body-contentsize-small');
	  $('body').removeClass('body-contentsize-normal');
	  $('body').addClass('body-contentsize-big');
	  $('body').removeClass('body-contentsize-large');
	  //active button
	  $('.options-sizesmall').removeClass('options-button-active');
	  $('.options-sizenormal').removeClass('options-button-active');
	  $('.options-sizebig').addClass('options-button-active');
	  $('.options-sizelarge').removeClass('options-button-active');
  }
  function SizeLarge() {
	  $('body').removeClass('body-contentsize-small');
	  $('body').removeClass('body-contentsize-normal');
	  $('body').removeClass('body-contentsize-big');
	  $('body').addClass('body-contentsize-large');
	  //active button
	  $('.options-sizesmall').removeClass('options-button-active');
	  $('.options-sizenormal').removeClass('options-button-active');
	  $('.options-sizebig').removeClass('options-button-active');
	  $('.options-sizelarge').addClass('options-button-active');
  }

/**
 *  Open pannel
 */
//Search
function Search() {
	$(".search").toggleClass("ready");
	$(".search-close").toggleClass("ready");
	//Ban or allow scroll
	if($(".search").hasClass("ready")) {
		allowScroll();
	}else{
		banScroll();
	}
}
//Login
function Login() {
	$(".login").toggleClass("ready");
	$(".login-close").toggleClass("ready");
	//Ban or allow scroll
	if($(".login").hasClass("ready")) {
		allowScroll();
	}else{
		banScroll();
	}
}

/**
 *  Drawer
 */
function toggleDrawer() {
	$("body").toggleClass("drawer-open");
	$(".mask").toggleClass("mask-open");
	//Ban or allow scroll
	if($("body").hasClass("drawer-open")) {
		banScroll();
	}else{
		allowScroll();
	}
}

/**
 *  Alert
 */
function alertSend(content,auto) {
	$(".alert-content").text(content);
	$(".alert").removeClass("ready");
	if (auto===true) {
		window.setTimeout(function(){$(".alert").addClass("ready");},2000);
	}
}
function alertClose() {
	$(".alert").addClass("ready");
}

/**
 *  Listen copy event and alert
 */
$(document).ready(function() {  
    $("body").bind({  
        copy : function(){  
          alertSend("复制成功！若使用请注明原作者及原地址！",true);
        }
    });  
});   

/**
 *  Event Listeners
 */
/* GetElementById */
function idGetEl(id) {
	var el = document.getElementById(id);
	return el;
}

/* Find Elements */
var goTopButton = idGetEl("gotop");
var fullMask = idGetEl("full-mask");
var searchCloseButton = idGetEl("search-close-button");
var searchOpenButton = idGetEl("search-open-button");
var searchOpenMobile = idGetEl("search-open-mobile");
var loginCloseButton = idGetEl("login-close");
var loginOpenButton = idGetEl("login-open");
var loginOpenMobile = idGetEl("login-open-mobile");
var toggleMobileMenuClose = idGetEl("toggle-mobile-menu-close");
var toggleMobileMenu = idGetEl("toggle-mobile-menu-button");
var toggleOptions = idGetEl("toggle-options-button");
var toggleOptionsMobile = idGetEl("toggle-options-mobile");
var alertCloseButton = idGetEl("alert-close");
var drawerButton = idGetEl("drawer-button");

/* Add Listeners */
//返回顶部按钮
goTopButton.addEventListener("click", GoTop);
//全屏遮罩（抽屉栏）
fullMask.addEventListener("click", function(){
	toggleDrawer();
	$('.options').addClass('ready');
});
//打开/关闭搜索面板
searchCloseButton.addEventListener("click", Search);
searchOpenButton.addEventListener("click", Search);
searchOpenMobile.addEventListener("click", Search);
//打开/关闭登录面板
loginCloseButton.addEventListener("click", Login);
loginOpenButton.addEventListener("click", Login);
loginOpenMobile.addEventListener("click", Login);
//开关移动端导航
toggleMobileMenuClose.addEventListener("click", function(){
	$(".mobile-menu").toggleClass("ready");
	$(".mobile-menu-close").toggleClass("ready");
	allowScroll();
});
toggleMobileMenu.addEventListener("click", function(){
	$(".mobile-menu").toggleClass("ready");
	$(".mobile-menu-close").toggleClass("ready");
	banScroll();
});
//开关设置面板
toggleOptions.addEventListener("click", function(){
	$(".options").toggleClass("ready");
});
toggleOptionsMobile.addEventListener("click", function(){
	$(".options").toggleClass("ready");
});
//关闭 Alert
alertCloseButton.addEventListener("click", alertClose);

/**
 *  Load Pjax
 */
if(loadPjax = true) {
  $(document).pjax('a[href^="' + siteurl + '"]:not(a[target="_blank"], a[no-pjax], .comment-reply a, .cancel-comment-reply a)', {
    container: '#pjax-container',fragment: '#pjax-container',timeout: 8000
  }).on('pjax:send', function () {
	GoTop();
	//Others
	beforePjax();
  }).on('pjax:complete', function () {
	//Front-end Login
	$('form#login-form').addClass('need-refresh');
	//Close Mobile Menu after pjax finishes
	$(".mobile-menu").addClass("ready");
	$(".mobile-menu-close").addClass("ready");
	allowScroll();
	//Animation
	$(".post-list").addClass("fadein").hide().fadeIn(300);
	$(".post-body").addClass("fadein").hide().fadeIn(300);
	$(".comment").addClass("fadein").hide().fadeIn(300);
	$("#pjax-container").css({'height':'auto'});
	//NProgress
	NProgress.done();
	//Reload
	LazyLoad();
	highlight();
	panguLoad();
	//Others
	afterPjax();
  });
}

/**
 *  Comply First
 */
(function() {
	panguLoad();
	LazyLoad();
	highlight();
})();

/**
 *  Copyright
 */
console.log("%c 🎉 Theme Miracles %c by Eltrac %c 仓库: https://github.com/BigCoke233/miracles %c 演示：https://guhub.cn","color: #fff; margin: 1em 0; padding: 5px 0; background: #29c75f;","margin: 1em 0; padding: 5px 0; background: #efefef;","display: block;margin-left:-0.5em;","display: block;margin-left:-0.5em;margin-bottom:1em");